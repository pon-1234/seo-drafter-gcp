main:
  params: [event]
  steps:
    - assign:
        assign:
          - job_id: ${event.job_id}
          - draft_id: ${default(map.get(event, "draft_id"), job_id)}
          - project_id: "seo-drafter-gcp"
          - worker_url: "https://seo-drafter-worker-yxk2eqrkvq-an.a.run.app"
          - backend_url: "https://seo-drafter-api-yxk2eqrkvq-an.a.run.app"
    - callWorker:
        call: http.post
        args:
          url: ${worker_url + "/run-pipeline"}
          headers:
            Content-Type: application/json
          timeout: 900
          body:
            job_id: ${job_id}
            draft_id: ${draft_id}
            project_id: ${project_id}
            primary_keyword: ${event.primary_keyword}
            supporting_keywords: ${event.supporting_keywords}
            prompt_version: ${event.prompt_version}
            persona: ${event.persona}
            intent: ${event.intent}
            word_count_range: ${event.word_count_range}
            prohibited_claims: ${event.prohibited_claims}
            style_guide_id: ${event.style_guide_id}
            existing_article_ids: ${event.existing_article_ids}
            article_type: ${event.article_type}
            intended_cta: ${event.intended_cta}
            persona_brief: ${event.persona_brief}
            notation_guidelines: ${event.notation_guidelines}
            heading_directive: ${event.heading_directive}
            reference_urls: ${event.reference_urls}
            output_format: ${event.output_format}
            quality_rubric: ${event.quality_rubric}
            writer_persona: ${event.writer_persona}
            preferred_sources: ${event.preferred_sources}
            reference_media: ${event.reference_media}
            project_template_id: ${event.project_template_id}
            llm: ${event.llm}
            serp_snapshot: ${event.serp_snapshot}
            expertise_level: ${event.expertise_level}
            tone: ${event.tone}
          auth:
            type: OIDC
        result: workerResponse
    - persistOutputs:
        call: http.post
        args:
          url: ${backend_url + "/internal/drafts"}
          headers:
            Content-Type: application/json
          body:
            job_id: ${job_id}
            draft_id: ${draft_id}
            payload: ${workerResponse.body.result}
          auth:
            type: OIDC
    - return:
        return: ${workerResponse.body}
